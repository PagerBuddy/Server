<!DOCTYPE html>
<html lang="en">
<head>
    
    <meta charset="utf-8">
    <title>websocket.mjs - Documentation</title>
    
    
    <script src="scripts/prettify/prettify.js"></script>
    <script src="scripts/prettify/lang-css.js"></script>
    <!--[if lt IE 9]>
      <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
    <![endif]-->
    <link type="text/css" rel="stylesheet" href="styles/prettify.css">
    <link type="text/css" rel="stylesheet" href="styles/jsdoc.css">
    <script src="scripts/nav.js" defer></script>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>

<input type="checkbox" id="nav-trigger" class="nav-trigger" />
<label for="nav-trigger" class="navicon-button x">
  <div class="navicon"></div>
</label>

<label for="nav-trigger" class="overlay"></label>

<nav >
    
    <h2><a href="index.html">Home</a></h2><h3>Classes</h3><ul><li><a href="Config_Config.html">Config</a></li><li><a href="database_database.html">database</a></li><li><a href="module.exports_module.exports.html">exports</a></li></ul><h3>Modules</h3><ul><li><a href="module-backup.html">backup</a><ul class='methods'><li data-type='method'><a href="module-backup.html#~copy_db">copy_db</a></li><li data-type='method'><a href="module-backup.html#~get_current_timestamp">get_current_timestamp</a></li></ul></li><li><a href="module-health.html">health</a><ul class='methods'><li data-type='method'><a href="module-health.html#.get_health_report">get_health_report</a></li><li data-type='method'><a href="module-health.html#.get_time_offset">get_time_offset</a></li><li data-type='method'><a href="module-health.html#.init">init</a></li><li data-type='method'><a href="module-health.html#.radio_activity">radio_activity</a></li><li data-type='method'><a href="module-health.html#.report_health">report_health</a></li><li data-type='method'><a href="module-health.html#.telegram_status">telegram_status</a></li></ul></li><li><a href="module-logging.html">logging</a><ul class='methods'><li data-type='method'><a href="module-logging.html#.connect_telegram_transport">connect_telegram_transport</a></li><li data-type='method'><a href="module-logging.html#.set_logging_level">set_logging_level</a></li></ul></li><li><a href="module-messaging.html">messaging</a><ul class='methods'><li data-type='method'><a href="module-messaging.html#.heartbeatProbe">heartbeatProbe</a></li><li data-type='method'><a href="module-messaging.html#.init">init</a></li><li data-type='method'><a href="module-messaging.html#.sendAlert">sendAlert</a></li><li data-type='method'><a href="module-messaging.html#.sendTest">sendTest</a></li><li data-type='method'><a href="module-messaging.html#~getAccessToken">getAccessToken</a></li><li data-type='method'><a href="module-messaging.html#~getFCMJSON">getFCMJSON</a></li><li data-type='method'><a href="module-messaging.html#~sendFcmMessages">sendFcmMessages</a></li></ul></li><li><a href="module-server.html">server</a><ul class='methods'><li data-type='method'><a href="module-server.html#.queue_alarm">queue_alarm</a></li><li data-type='method'><a href="module-server.html#.start">start</a></li><li data-type='method'><a href="module-server.html#.stop">stop</a></li><li data-type='method'><a href="module-server.html#~alarm">alarm</a></li><li data-type='method'><a href="module-server.html#~queue_katsys">queue_katsys</a></li><li data-type='method'><a href="module-server.html#~run_queue">run_queue</a></li><li data-type='method'><a href="module-server.html#~setup_cleaner">setup_cleaner</a></li><li data-type='method'><a href="module-server.html#~step_alarms">step_alarms</a></li></ul></li><li><a href="module-websocket.html">websocket</a><ul class='methods'><li data-type='method'><a href="module-websocket.html#.init">init</a></li><li data-type='method'><a href="module-websocket.html#.start_listening">start_listening</a></li></ul></li></ul><h3>Global</h3><ul><li><a href="global.html#create_database">create_database</a></li><li><a href="global.html#levelToZVEI">levelToZVEI</a></li></ul>
</nav>

<div id="main">
    
    <h1 class="page-title">websocket.mjs</h1>
    

    



    
    <section>
        <article>
            <pre class="prettyprint source linenums"><code>/**@module websocket */

import * as  http from 'http';
import { Server } from "socket.io";
import winston from 'winston';

import logging from './logging.mjs';
import * as myhealth from './health.mjs';

/**@type {winston.Logger} */
let logger;

/**@type {boolean} */
let ENABLED = false;

/** @type {Number} */
let PORT;
/** @type {myhealth} */
let health;

/** @type {http.Server} */
let server;
/**@type {Server} */
let io;

/**
 * 
 * @param {{enabled: boolean, port: number}} config 
 * @param {myhealth} health_ 
 */
export function init(config, health_) {
    logger = logging("Websocket");
    ENABLED = config.enabled;
    PORT = config.port;
    health = health_;
}

/**
 * @callback AlarmCallback
 * @param {number} zvei_id
 * @param {number} timestamp
 * @param {number} information_content
 * @param {string} text
 */

/**
 * Subscribe to input devices.
 * @param {AlarmCallback} alarm_callback Callback to fire with an alarm item.
 * @returns {Promise&lt;boolean>}
 */
export function start_listening(alarm_callback) {
    if(!ENABLED){
        return Promise.resolve(false);
    }


    /**@type {http.RequestListener} */
    const requestListener = function (req, res) {
        res.writeHead(404);
        res.end();
    };

    server = http.createServer(requestListener);
    io = new Server(server);

    io.on('connection', (socket) => {
        logger.debug('A connection to an alert interface was established.');
        socket.on('health', (/**@type {{siteId: String, type: String, device: String, status: String, group: String, csq: String, timestamp: number}} */ data) => {
            health.report_health(data);
        });
        socket.on('zvei', async (/**@type {{siteId: string, type: string, zvei: string, timestamp: number}} */ data) => {
            logger.debug(`Received ZVEI alert ${data.zvei} from ${data.siteId}`);
            let offset = health.get_time_offset(data.siteId);
            alarm_callback(parseInt(data.zvei), data.timestamp - offset, 1, '');
            health.radio_activity(data);
        });
        socket.on('aprt', async (/**@type {{siteId: string, type: string, subZvei: string, subDec: String, subHex: String, emergencyReason: String, emergencyCity: String, emergencySite: String, from: String, to: String, timestamp: number}} */ data) => {
            logger.debug(`Received APRT alert ${data.subZvei} from ${data.siteId}`);
            let offset = health.get_time_offset(data.siteId);
            let msg = '&lt;b>' + data.emergencyReason + '&lt;/b>\n' + data.emergencyCity
            alarm_callback(parseInt(data.subZvei), data.timestamp - offset, 2, msg);
            health.radio_activity(data);
        });
        socket.on('status', (data) => {
            // TODO this should probably be implemented
            //console.log('status'); //Ignore this for now
            //console.log(data);
        });
        socket.on('disconnect', () => {
            logger.debug('An alert interface disconnected.');
        });
    });

    server.on('error', (e) => {
        // @ts-ignore - e.code does exist, contrary to ts beliefs
        if (e.code === 'EADDRINUSE') {
            logger.error(`Address in use ${PORT}. This is fatal for incoming interfaces. Probably a different instance is already active.`);
        }
    });

    return new Promise((resolve) => {
        server.listen(PORT, () => {
            logger.debug(`Listening on port ${PORT} for incoming websocket connections.`);
            resolve(true);
        });
    });
}

export function stop_listening() {
    if (io != null) {
        io.close();
    }

    if (server != null) {
        server.close();
    }
}</code></pre>
        </article>
    </section>




    
    
</div>

<br class="clear">

<footer>
    Documentation generated by <a href="https://github.com/jsdoc3/jsdoc">JSDoc 3.6.7</a> on Mon Oct 03 2022 07:13:38 GMT+0000 (Coordinated Universal Time) using the <a href="https://github.com/clenemt/docdash">docdash</a> theme.
</footer>

<script>prettyPrint();</script>
<script src="scripts/polyfill.js"></script>
<script src="scripts/linenumber.js"></script>



</body>
</html>
